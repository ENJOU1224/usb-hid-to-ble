/*********************************************************************
 * File Name          : main.c
 * Author             : DIY User & AI Assistant
 * Version            : V9.0 (Release Candidate)
 * Description        : NiZ 键盘蓝牙适配器主程序
 *                      集成 USB Host 桥接、蓝牙广播、电源管理与看门狗保护
 *********************************************************************/

#include "CONFIG.h"
#include "HAL.h"
#include "hiddev.h"
#include "hidkbd.h"

// ===================================================================
// ? 工程配置说明 (Project Configuration)
// 建议在 MounRiver Studio 的工程属性 -> C/C++ Build -> Settings -> Preprocessor 中定义
// ===================================================================

/* 
 * [1. 调试模式 DEBUG]
 * 作用: 控制串口打印 (PA9/PB7 等引脚)。
 * 设置: 调试时定义 DEBUG=1；成品使用时建议删除该宏 (DEBUG=0)，以省电并防止串口泄露信息。
 */
// #define DEBUG 1  // (建议在 IDE 工程属性中定义，此处仅作说明)

/* 
 * [2. 电源模式 DCDC_ENABLE]
 * 作用: 决定是否开启内部 DCDC 降压。
 * 设置: 如果板子上有电感(通常是黑色方块4R7/10uH)，定义为 1 (推荐，省电30%)。
 *       如果板子上只有电容无电感，必须定义为 0，否则芯片无法工作。
 */
// #define DCDC_ENABLE 1 // (建议在 IDE 工程属性中定义)

/* 
 * [3. 蓝牙地址 BLE_MAC]
 * 作用: 是否使用自定义 MAC 地址。
 * 设置: 建议删除该宏。默认使用芯片出厂唯一 ID，避免多设备冲突。
 */
// #define BLE_MAC 1    // (建议删除，使用芯片自带唯一ID) 

// ===================================================================
// ? 外部函数与全局变量
// ===================================================================
// 引用 usb_bridge.c 中的核心函数
extern void USB_Bridge_Init(void);
extern void USB_Bridge_Poll(void);

// 蓝牙协议栈使用的内存堆 (由芯片库文件管理，勿动)
__attribute__((aligned(4))) uint32_t MEM_BUF[BLE_MEMHEAP_SIZE / 4];

// 如果用户非要自定义 MAC 地址，则编译此段 (不推荐)
#if(defined(BLE_MAC)) && (BLE_MAC == TRUE)
    const uint8_t MacAddr[6] = {0x84, 0xC2, 0xE4, 0x03, 0x02, 0x02};
#endif


// ===================================================================
// ? 系统主循环 (Core Loop)
// ===================================================================
// 注意：此函数不能内联，且应尽量精简，保证响应速度
__HIGH_CODE
__attribute__((noinline))
void Main_Circulation()
{
    while(1)
    {
        // 1. 蓝牙协议栈调度 (处理广播、连接、数据发送)
        TMOS_SystemProcess();

        // 2. USB 桥接任务 (处理键盘枚举、数据读取、流控)
        USB_Bridge_Poll();
        
        // 3. 喂狗 (Feed the Dog)
        // 告诉看门狗：“我还活着，不要重启我”
        #ifdef ENABLE_WATCHDOG
            R8_WDOG_COUNT = 0; 
        #endif
    }
}

// ===================================================================
// ? 程序入口 (Entry Point)
// ===================================================================
int main(void)
{
    // ----------------------------------------------------------------
    // 1. 基础硬件初始化
    // ----------------------------------------------------------------
    
    // 配置电源管理 (根据工程宏定义自动判断)
#if(defined(DCDC_ENABLE)) && (DCDC_ENABLE == TRUE)
    PWR_DCDCCfg(ENABLE); // 开启 DCDC，显著降低功耗
#else
    PWR_DCDCCfg(DISABLE); // 无电感时使用 LDO 模式
#endif
    
    // 设置系统主频为 60MHz (平衡性能与功耗的最佳点)
    SetSysClock(CLK_SOURCE_PLL_60MHz);

    // ----------------------------------------------------------------
    // 2. 调试接口初始化
    // ----------------------------------------------------------------
#ifdef DEBUG
    // 只有在定义了 DEBUG 宏时才编译这部分代码
    GPIOA_SetBits(bTXD1);               // 串口 TX 拉高
    GPIOA_ModeCfg(bTXD1, GPIO_ModeOut_PP_5mA); // 推挽输出
    UART1_DefInit();                    // 默认波特率 115200
    PRINT("--------------------------------\n");
    PRINT("NiZ Wireless Adapter V9.0 Start\n");
    PRINT("Build Date: %s\n", __DATE__);
    PRINT("--------------------------------\n");
#endif

    // ----------------------------------------------------------------
    // 3. 蓝牙协议栈初始化 (固定流程)
    // ----------------------------------------------------------------
    CH58X_BLEInit();            // BLE 库初始化
    HAL_Init();                 // 硬件抽象层初始化
    GAPRole_PeripheralInit();   // 从机角色初始化 (广播)
    HidDev_Init();              // HID 服务初始化
    HidEmu_Init();              // 键盘应用层初始化

    // ----------------------------------------------------------------
    // 4. USB Host 初始化 (业务核心)
    // ----------------------------------------------------------------
    // 务必放在蓝牙初始化之后，确保系统时钟稳定
    USB_Bridge_Init(); 

    // ----------------------------------------------------------------
    // 5. 启动看门狗 (最后一步)
    // ----------------------------------------------------------------
#ifdef ENABLE_WATCHDOG
    // 开启看门狗，设置溢出时间。
    // RB_WDOG_INT_EN: 允许中断
    // RB_WDOG_RST_EN: 允许复位 (关键)
    // 0x80: 预分频系数，大约对应 1.6秒 超时
    R8_RST_WDOG_CTRL = RB_WDOG_RST_EN | RB_WDOG_INT_EN; 
    #ifdef DEBUG
    PRINT("Watchdog: ENABLED (Timeout ~1.6s)\n");
    #endif
#endif

    // ----------------------------------------------------------------
    // 6. 跳转至主循环
    // ----------------------------------------------------------------
    Main_Circulation();
}

/******************************** endfile @ main ******************************/