/*********************************************************************
 * File Name          : main.c
 * Author             : DIY User & AI Assistant
 * Version            : V9.1 (Optimized & Annotated)
 * Description        : NiZ 键盘蓝牙适配器主程序入口
 *                      - 系统时钟与电源配置
 *                      - 任务调度器 (TMOS) 主循环
 *                      - USB 与 BLE 协议栈的协同调度
 *                      - 硬件看门狗 (Watchdog) 保护
 *********************************************************************/

#include "CONFIG.h"
#include "HAL.h"
#include "hiddev.h"
#include "hidkbd.h"
#include "debug.h"

// ===================================================================
// ? 外部引用 (External References)
// ===================================================================
extern void USB_Bridge_Init(void);
extern void USB_Bridge_Poll(void);

// ===================================================================
// ? 全局内存配置 (Memory Config)
// ===================================================================

// BLE 协议栈专用堆内存 (必须 4字节对齐)
__attribute__((aligned(4))) uint32_t MEM_BUF[BLE_MEMHEAP_SIZE / 4];

// [可选] 自定义 MAC 地址
// 如果注释掉，芯片将使用出厂预烧录的唯一 MAC
#if(defined(BLE_MAC)) && (BLE_MAC == TRUE)
    const uint8_t MacAddr[6] = {0x84, 0xC2, 0xE4, 0x03, 0x02, 0x02};
#endif

// ===================================================================
// ? 系统主循环 (Core Loop)
// ===================================================================
// 此函数为死循环，负责整个系统的任务调度
// __attribute__((noinline)) 防止编译器过度优化导致循环结构异常
__HIGH_CODE
__attribute__((noinline))
void Main_Circulation()
{
    while(1)
    {
        // 1. 蓝牙协议栈调度 (必须频繁调用)
        // 处理广播、连接维护、数据收发回调
        TMOS_SystemProcess();

        // 2. USB 桥接任务 (必须频繁调用)
        // 轮询 USB 键盘/鼠标数据，维护 USB Host 状态机
        USB_Bridge_Poll();
        
        // 3. 喂狗 (Feed Watchdog)
        // 只要程序跑到了这里，说明没有卡死，重置看门狗计数器
        #ifdef ENABLE_WATCHDOG
            R8_WDOG_COUNT = 0; 
        #endif
    }
}

// ===================================================================
// ? 程序入口 (Main Entry)
// ===================================================================
int main(void)
{
    // ----------------------------------------------------------------
    // 1. 基础硬件与时钟初始化
    // ----------------------------------------------------------------
    
    // DCDC 电源配置 (降低功耗)
#if(defined(DCDC_ENABLE)) && (DCDC_ENABLE == TRUE)
    PWR_DCDCCfg(ENABLE); 
#else
    PWR_DCDCCfg(DISABLE); // 无电感设计必须禁用 DCDC
#endif
    
    // 设置系统主频为 60MHz
    // 推荐 60MHz 而非 48MHz，因为 USB Host 需要较快的响应速度处理中断
    SetSysClock(CLK_SOURCE_PLL_60MHz);

    // ----------------------------------------------------------------
    // 2. GPIO 初始化 (LED)
    // ----------------------------------------------------------------
    // 1. LED 硬件初始化
    LED_HW_INIT(); 

    // ----------------------------------------------------------------
    // 3. 调试串口初始化
    // ----------------------------------------------------------------
#ifdef DEBUG
    GPIOA_SetBits(bTXD1); // TXD1 (PA9) 置高
    GPIOA_ModeCfg(bTXD1, GPIO_ModeOut_PP_5mA);
    UART1_DefInit();      // 默认波特率 (通常 115200)
#endif

    LOG_SYS("\n================================\n");
    LOG_SYS("   ENJOU Wireless Adapter V9.1  \n");
    LOG_SYS("   Build: %s %s       \n", __DATE__, __TIME__);
    LOG_SYS("================================\n");

    // ----------------------------------------------------------------
    // 4. 蓝牙协议栈初始化 (Standard Sequence)
    // ----------------------------------------------------------------
    LOG_SYS("[Init] BLE Stack...\n");
    CH58X_BLEInit();            // 库文件初始化
    HAL_Init();                 // 硬件抽象层初始化
    GAPRole_PeripheralInit();   // 角色初始化
    HidDev_Init();              // HID 服务层初始化
    HidEmu_Init();              // 用户应用层 (键盘逻辑) 初始化

    // ----------------------------------------------------------------
    // 5. USB Host 初始化 (Critical)
    // ----------------------------------------------------------------
    // 务必放在 BLE 初始化之后，避免 USB 初始化的延时影响 BLE 时序
    LOG_SYS("[Init] USB Host...\n");
    USB_Bridge_Init(); 

    // ----------------------------------------------------------------
    // 6. 看门狗配置 (System Safety)
    // ----------------------------------------------------------------
#ifdef ENABLE_WATCHDOG
    // R8_RST_WDOG_CTRL 寄存器说明:
    // RB_WDOG_RST_EN: 允许看门狗复位系统
    // RB_WDOG_INT_EN: 允许看门狗产生中断 (通常配合复位一起开)
    // 0x80          : 预分频值，决定溢出时间 (约 1.6s @ 32KHz LSI)
    R8_RST_WDOG_CTRL = RB_WDOG_RST_EN | RB_WDOG_INT_EN; 
    LOG_SYS("[Init] Watchdog Enabled (1.6s)\n");
#endif

    // ----------------------------------------------------------------
    // 7. 启动完成
    // ----------------------------------------------------------------
    // 点亮 LED1 表示系统已进入主循环，电源正常
    LED1_ON(); 
    LOG_SYS(">> System Running <<\n");

    // 跳转至死循环
    Main_Circulation();
}

/******************************** endfile @ main ******************************/